(paiprolog:<- (arrow id414))
(paiprolog:<- (arrow id397))
(paiprolog:<- (arrow id386))
(paiprolog:<- (arrow id378))
(paiprolog:<- (arrow id373))
(paiprolog:<- (arrow-x id414 9810))
(paiprolog:<- (arrow-x id397 14046300000000001))
(paiprolog:<- (arrow-x id386 93463))
(paiprolog:<- (arrow-x id378 9810))
(paiprolog:<- (arrow-x id373 11946300000000001))
(paiprolog:<- (arrow-y id414 45363))
(paiprolog:<- (arrow-y id397 400))
(paiprolog:<- (arrow-y id386 400))
(paiprolog:<- (arrow-y id378 21363))
(paiprolog:<- (arrow-y id373 400))
(paiprolog:<- (rect id426))
(paiprolog:<- (rect id415))
(paiprolog:<- (rect id398))
(paiprolog:<- (rect id379))
(paiprolog:<- (roundedrect id429))
(paiprolog:<- (metadata id427 id430))
(paiprolog:<- (dot id423))
(paiprolog:<- (dot id418))
(paiprolog:<- (dot id403))
(paiprolog:<- (line id410))
(paiprolog:<- (line id393))
(paiprolog:<- (line id382))
(paiprolog:<- (line id374))
(paiprolog:<- (line id369))
(paiprolog:<- (text id430 struidG428))
(paiprolog:<- (text id424 struidG425))
(paiprolog:<- (text id421 struidG422))
(paiprolog:<- (text id419 struidG420))
(paiprolog:<- (text id416 struidG417))
(paiprolog:<- (text id408 struidG409))
(paiprolog:<- (text id406 struidG407))
(paiprolog:<- (text id404 struidG405))
(paiprolog:<- (text id401 struidG402))
(paiprolog:<- (text id399 struidG400))
(paiprolog:<- (text id391 struidG392))
(paiprolog:<- (text id389 struidG390))
(paiprolog:<- (text id387 struidG388))
(paiprolog:<- (text id380 struidG381))
(paiprolog:<- (bounding-box-left id412 970))
(paiprolog:<- (bounding-box-left id411 9610))
(paiprolog:<- (bounding-box-left id395 1390))
(paiprolog:<- (bounding-box-left id394 12610))
(paiprolog:<- (bounding-box-left id384 920))
(paiprolog:<- (bounding-box-left id383 7310))
(paiprolog:<- (bounding-box-left id376 970))
(paiprolog:<- (bounding-box-left id375 9610))
(paiprolog:<- (bounding-box-left id371 1180))
(paiprolog:<- (bounding-box-left id370 10010))
(paiprolog:<- (bounding-box-top id412 440))
(paiprolog:<- (bounding-box-top id411 2800))
(paiprolog:<- (bounding-box-top id395 20))
(paiprolog:<- (bounding-box-top id394 200))
(paiprolog:<- (bounding-box-top id384 20))
(paiprolog:<- (bounding-box-top id383 200))
(paiprolog:<- (bounding-box-top id376 200))
(paiprolog:<- (bounding-box-top id375 600))
(paiprolog:<- (bounding-box-top id371 20))
(paiprolog:<- (bounding-box-top id370 200))
(paiprolog:<- (bounding-box-right id412 1010))
(paiprolog:<- (bounding-box-right id411 10010))
(paiprolog:<- (bounding-box-right id395 1430))
(paiprolog:<- (bounding-box-right id394 13010))
(paiprolog:<- (bounding-box-right id384 960))
(paiprolog:<- (bounding-box-right id383 7710))
(paiprolog:<- (bounding-box-right id376 1010))
(paiprolog:<- (bounding-box-right id375 10010))
(paiprolog:<- (bounding-box-right id371 1220))
(paiprolog:<- (bounding-box-right id370 10410))
(paiprolog:<- (bounding-box-bottom id412 480))
(paiprolog:<- (bounding-box-bottom id411 3200))
(paiprolog:<- (bounding-box-bottom id395 60))
(paiprolog:<- (bounding-box-bottom id394 600))
(paiprolog:<- (bounding-box-bottom id384 60))
(paiprolog:<- (bounding-box-bottom id383 600))
(paiprolog:<- (bounding-box-bottom id376 240))
(paiprolog:<- (bounding-box-bottom id375 1000))
(paiprolog:<- (bounding-box-bottom id371 60))
(paiprolog:<- (bounding-box-bottom id370 600))
(paiprolog:<- (component compile-composites))
(paiprolog:<- (edge id413))
(paiprolog:<- (edge id396))
(paiprolog:<- (edge id385))
(paiprolog:<- (edge id377))
(paiprolog:<- (edge id372))
(paiprolog:<- (eltype id429 roundedrect))
(paiprolog:<- (eltype id427 metadata))
(paiprolog:<- (eltype id426 box))
(paiprolog:<- (eltype id423 dot))
(paiprolog:<- (eltype id418 dot))
(paiprolog:<- (eltype id415 box))
(paiprolog:<- (eltype id412 port))
(paiprolog:<- (eltype id411 port))
(paiprolog:<- (eltype id403 dot))
(paiprolog:<- (eltype id398 box))
(paiprolog:<- (eltype id395 port))
(paiprolog:<- (eltype id394 port))
(paiprolog:<- (eltype id384 port))
(paiprolog:<- (eltype id383 port))
(paiprolog:<- (eltype id379 box))
(paiprolog:<- (eltype id376 port))
(paiprolog:<- (eltype id375 port))
(paiprolog:<- (eltype id371 port))
(paiprolog:<- (eltype id370 port))
(paiprolog:<- (geometry-h id430 12))
(paiprolog:<- (geometry-h id429 22))
(paiprolog:<- (geometry-h id426 2300))
(paiprolog:<- (geometry-h id424 12))
(paiprolog:<- (geometry-h id423 400))
(paiprolog:<- (geometry-h id421 12))
(paiprolog:<- (geometry-h id419 12))
(paiprolog:<- (geometry-h id418 400))
(paiprolog:<- (geometry-h id416 12))
(paiprolog:<- (geometry-h id415 800))
(paiprolog:<- (geometry-h id408 12))
(paiprolog:<- (geometry-h id406 12))
(paiprolog:<- (geometry-h id404 12))
(paiprolog:<- (geometry-h id403 400))
(paiprolog:<- (geometry-h id401 12))
(paiprolog:<- (geometry-h id399 12))
(paiprolog:<- (geometry-h id398 800))
(paiprolog:<- (geometry-h id391 12))
(paiprolog:<- (geometry-h id389 12))
(paiprolog:<- (geometry-h id387 12))
(paiprolog:<- (geometry-h id380 12))
(paiprolog:<- (geometry-h id379 800))
(paiprolog:<- (geometry-w id430 10))
(paiprolog:<- (geometry-w id429 20))
(paiprolog:<- (geometry-w id426 9800))
(paiprolog:<- (geometry-w id424 13))
(paiprolog:<- (geometry-w id423 400))
(paiprolog:<- (geometry-w id421 13))
(paiprolog:<- (geometry-w id419 21))
(paiprolog:<- (geometry-w id418 400))
(paiprolog:<- (geometry-w id416 19))
(paiprolog:<- (geometry-w id415 800))
(paiprolog:<- (geometry-w id408 7))
(paiprolog:<- (geometry-w id406 4))
(paiprolog:<- (geometry-w id404 3))
(paiprolog:<- (geometry-w id403 400))
(paiprolog:<- (geometry-w id401 7))
(paiprolog:<- (geometry-w id399 19))
(paiprolog:<- (geometry-w id398 800))
(paiprolog:<- (geometry-w id391 7))
(paiprolog:<- (geometry-w id389 22))
(paiprolog:<- (geometry-w id387 11))
(paiprolog:<- (geometry-w id380 13))
(paiprolog:<- (geometry-w id379 800))
(paiprolog:<- (geometry-left-x id429 11705))
(paiprolog:<- (geometry-left-x id426 6910))
(paiprolog:<- (geometry-left-x id415 9410))
(paiprolog:<- (geometry-left-x id398 12010))
(paiprolog:<- (geometry-left-x id379 9410))
(paiprolog:<- (geometry-top-y id430 7285))
(paiprolog:<- (geometry-top-y id429 7185))
(paiprolog:<- (geometry-top-y id426 6100))
(paiprolog:<- (geometry-top-y id424 435))
(paiprolog:<- (geometry-top-y id423 400))
(paiprolog:<- (geometry-top-y id421 335))
(paiprolog:<- (geometry-top-y id419 5035))
(paiprolog:<- (geometry-top-y id418 5000))
(paiprolog:<- (geometry-top-y id416 2635))
(paiprolog:<- (geometry-top-y id415 2200))
(paiprolog:<- (geometry-top-y id408 3135))
(paiprolog:<- (geometry-top-y id406 2035))
(paiprolog:<- (geometry-top-y id404 435))
(paiprolog:<- (geometry-top-y id403 400))
(paiprolog:<- (geometry-top-y id401 335))
(paiprolog:<- (geometry-top-y id399 435))
(paiprolog:<- (geometry-top-y id398 00))
(paiprolog:<- (geometry-top-y id391 335))
(paiprolog:<- (geometry-top-y id389 1035))
(paiprolog:<- (geometry-top-y id387 335))
(paiprolog:<- (geometry-top-y id380 435))
(paiprolog:<- (geometry-top-y id379 00))
(paiprolog:<- (geometry-center-x id430 11855))
(paiprolog:<- (geometry-center-x id424 14505))
(paiprolog:<- (geometry-center-x id423 14510))
(paiprolog:<- (geometry-center-x id421 13205))
(paiprolog:<- (geometry-center-x id419 9805))
(paiprolog:<- (geometry-center-x id418 9810))
(paiprolog:<- (geometry-center-x id416 9805))
(paiprolog:<- (geometry-center-x id408 10005))
(paiprolog:<- (geometry-center-x id406 9605))
(paiprolog:<- (geometry-center-x id404 7105))
(paiprolog:<- (geometry-center-x id403 7110))
(paiprolog:<- (geometry-center-x id401 11755))
(paiprolog:<- (geometry-center-x id399 12405))
(paiprolog:<- (geometry-center-x id391 10505))
(paiprolog:<- (geometry-center-x id389 9955))
(paiprolog:<- (geometry-center-x id387 9055))
(paiprolog:<- (geometry-center-x id380 9805))
(paiprolog:<- (used id430))
(paiprolog:<- (port id412))
(paiprolog:<- (port id411))
(paiprolog:<- (port id395))
(paiprolog:<- (port id394))
(paiprolog:<- (port id384))
(paiprolog:<- (port id383))
(paiprolog:<- (port id376))
(paiprolog:<- (port id375))
(paiprolog:<- (port id371))
(paiprolog:<- (port id370))
(paiprolog:<- (source id413 id411))
(paiprolog:<- (source id396 id394))
(paiprolog:<- (source id385 id383))
(paiprolog:<- (source id377 id375))
(paiprolog:<- (source id372 id370))
(paiprolog:<- (sink id413 id412))
(paiprolog:<- (sink id396 id395))
(paiprolog:<- (sink id385 id384))
(paiprolog:<- (sink id377 id376))
(paiprolog:<- (sink id372 id371))



(defun readfb (stream)
  (flet ((read1 ()
           (read stream nil 'eof)))
    (paiprolog::clear-db)
    (let ((clause (read1)))
      (@:loop
        (@:exit-when (eq 'eof clause))
        (paiprolog::add-clause (paiprolog::replace-?-vars clause))
        (setf clause (read1))))))

(defun writefb (stream)
  (let ((preds paiprolog::*db-predicates*))
    (@:loop
     (@:exit-when (null preds))
     (let ((p (pop preds)))
       (let ((clauses (get p 'clauses)))
         (@:loop
          (@:exit-when (null clauses))
          (let ((c (pop clauses)))
            (write c :stream stream))))))))

(defun exactly-one (lis)
  (assert (= 1 (length lis)))
  (car lis))

(defun create-rect-bb (id)
  (let ((x (exactly-one (paiprolog:prolog-collect (?left) (geometry-left-x id ?left))))
        (y (exactly-one (paiprolog:prolog-collect (?top) (geometry-top-left id ?top))))
        (w (exactly-one (paiprolog:prolog-collect (?w) (geometry-w id ?w))))
        (h (exactly-one (paiprolog:prolog-collect (?h) (geometry-h id ?h)))))
    (let ((right (+ x w))
          (bottom (+ y h)))
      (paiprolog::add-clause `(bounding-box-left ,id ,x))
      (paiprolog::add-clause `(bounding-box-top ,id ,y))
      (paiprolog::add-clause `(bounding-box-right ,id ,right))
      (paiprolog::add-clause `(bounding-box-bottom ,id ,bottom)))))

(defun main ()
  (with-open-file (in "~/projects/bmfbp/svg/lparts/fb5.lisp" :direction :input)
    (with-open-file (out "~/projects/bmfbp/svg/lparts/fb6.lisp" :direction :output :if-exists :supersede)
      #+nil(readfb in)
      (let ((rect-list (paiprolog:prolog-collect (?R) (rect ?R))))
        (mapc #'(lambda (r)
                  (create-rect-bb r))
              rect-list))
      (writefb out))))



#|
:- initialization(main).
:- include('head').

main :-
    readFB(user_input), 
    createBoundingBoxes,
    writeFB,
    halt.

createBoundingBoxes :-
    conditionalCreateEllipseBB,
    condRect,
    condSpeech,
    condText.

condRect :-
    forall(rect(ID), createRectBoundingBox(ID)).
condRect :-
    true.

condSpeech :-
    forall(speechbubble(ID), createRectBoundingBox(ID)).
condSpeech :-
    true.

condText :-
    forall(text(ID,_), createTextBoundingBox(ID)).
condText :-
    true.

conditionalCreateEllipseBB:-
    ellipse(_),
    forall(ellipse(ID), createEllipseBoundingBox(ID)).

conditionalCreateEllipseBB :- % for pre-ellipse code  
    true.

createRectBoundingBox(ID) :-
    geometry_left_x(ID,X),
    geometry_top_y(ID, Y),
    geometry_w(ID, Width),
    geometry_h(ID, Height),
    asserta(bounding_box_left(ID,X)),
    asserta(bounding_box_top(ID,Y)),
    Right is X + Width,
    Bottom is Y + Height,
    asserta(bounding_box_right(ID,Right)),
    asserta(bounding_box_bottom(ID,Bottom)).

createTextBoundingBox(ID) :-
    geometry_center_x(ID,CX),
    geometry_top_y(ID, Y),
    geometry_w(ID, HalfWidth),
    geometry_h(ID, Height),
    X is (CX - HalfWidth),
    asserta(bounding_box_left(ID,X)),
    asserta(bounding_box_top(ID,Y)),
    Right is CX + HalfWidth,
    Bottom is Y + Height,
    asserta(bounding_box_right(ID,Right)),
    asserta(bounding_box_bottom(ID,Bottom)).

createEllipseBoundingBox(ID) :-
    geometry_center_x(ID,CX),
    geometry_center_y(ID,CY),
    geometry_w(ID,HalfWidth),
    geometry_h(ID,HalfHeight),
    Left is CX - HalfWidth,
    Top is CY - HalfHeight,
    asserta(bounding_box_left(ID,Left)),
    asserta(bounding_box_top(ID,Top)),
    Right is CX + HalfWidth,
    Bottom is CY + HalfHeight,
    asserta(bounding_box_right(ID,Right)),
    asserta(bounding_box_bottom(ID,Bottom)).

:- include('tail').
|#